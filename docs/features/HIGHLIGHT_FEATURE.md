# 文档高亮功能说明

## 🎯 功能概述

现在当你点击搜索结果中的文档预览时，搜索关键词会在文档内容中**高亮显示**。

### ✨ 智能关键词提取

系统会自动将搜索查询拆分成独立的关键词：
- **中文**：每个汉字作为一个关键词（例如："机器学习" → ['机', '器', '学', '习']）
- **英文**：每个单词作为一个关键词（例如："machine learning" → ['machine', 'learning']）
- **混合**：中英文分别处理（例如："Python机器学习" → ['Python', '机', '器', '学', '习']）

这意味着：
- ✅ 搜索"机器学习"会高亮所有包含"机"、"器"、"学"、"习"的地方
- ✅ 搜索"机器 学习"（两个词）效果相同
- ✅ 即使关键词不相邻也能高亮显示

## ✨ 实现的功能

### 1. 后端高亮处理
- 修改了 `/docs/{doc_id}` API 端点，新增 `q` 参数接收搜索关键词
- 在返回 HTML 内容前，自动用 `<mark>` 标签包裹匹配的关键词
- 支持多个关键词（空格分隔）
- 不区分大小写匹配

### 2. 前端交互增强
- JavaScript 自动从搜索框获取当前搜索关键词
- 请求文档时自动附带关键词参数
- 自动滚动到第一个高亮位置

### 3. 视觉效果
- 高亮背景色：亮黄色 (#fef08a)
- 添加了脉冲动画效果
- 增加了阴影，让高亮更明显

## 📝 使用方法

### 方法 1：通过搜索页面（自动）
1. 在搜索框输入关键词，例如："机器学习"
2. 点击任意搜索结果
3. 文档预览中会自动高亮显示"机器学习"

### 方法 2：直接访问 API
```bash
# 访问文档并高亮关键词
http://127.0.0.1:8000/docs/1?q=机器学习

# 高亮多个关键词
http://127.0.0.1:8000/docs/1?q=机器学习 算法
```

## 🔧 技术细节

### 修改的文件

1. **app/api.py**
   - 添加了 `q` 参数到 `get_document()` 函数
   - 实现了关键词高亮逻辑

2. **app/static/script.js**
   - 修改了 `showDocumentPreview()` 函数
   - 自动获取搜索关键词并传递给 API
   - 添加了自动滚动到高亮位置的功能

3. **app/static/style.css**
   - 添加了 `.preview-content mark` 样式
   - 添加了高亮脉冲动画

### 高亮算法

**步骤 1：提取关键词**
```python
# 将查询拆分成独立的关键词
# 中文：每个字一个关键词
# 英文：每个单词一个关键词
keywords = []
for char in query:
    is_cjk = '\u4e00' <= char <= '\u9fff'  # 中文字符
    if is_cjk:
        keywords.append(char)  # 中文单字
    elif char.isalnum():
        # 英文字符累积成单词
        ...
```

**步骤 2：高亮每个关键词**
```python
for keyword in keywords:
    escaped_keyword = re.escape(keyword)
    # 中文单字：直接匹配
    if len(keyword) == 1 and is_chinese(keyword):
        pattern = re.compile(f'({escaped_keyword})', re.IGNORECASE)
    # 英文单词：使用词边界
    else:
        pattern = re.compile(f'\\b({escaped_keyword})\\b', re.IGNORECASE)
    # 用 <mark> 标签包裹
    html_content = pattern.sub(r'<mark>\1</mark>', html_content)
```

## 🎨 样式效果

```css
.preview-content mark {
    background-color: #fef08a;      /* 亮黄色背景 */
    padding: 0.2rem 0.3rem;         /* 内边距 */
    border-radius: 3px;             /* 圆角 */
    font-weight: 500;               /* 加粗 */
    box-shadow: 0 0 0 2px rgba(254, 240, 138, 0.3);  /* 外发光 */
    animation: highlight-pulse 0.5s ease-in-out;     /* 脉冲动画 */
}
```

## 🚀 如何测试

1. **重启服务器**（如果使用 `--reload` 模式会自动重载）
   ```bash
   # 关闭当前服务器窗口，然后重新运行
   python -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8000
   ```

2. **测试步骤**
   - 打开浏览器访问：http://127.0.0.1:8000
   - 搜索任意关键词，例如："算法"
   - 点击任意搜索结果
   - 查看右侧预览面板，关键词应该被黄色高亮

3. **验证效果**
   - ✅ 关键词被黄色背景高亮
   - ✅ 页面自动滚动到第一个高亮位置
   - ✅ 支持中英文关键词
   - ✅ 支持多个关键词

## 💡 注意事项

1. **关键词来源**：高亮的关键词来自搜索框的输入
2. **多关键词**：用空格分隔多个关键词
3. **大小写**：不区分大小写匹配
4. **性能**：对于超长文档，高亮处理可能需要一点时间

## 🐛 已知限制

1. 不会在 HTML 标签内部高亮（避免破坏 HTML 结构）
2. 代码块内的关键词也会被高亮
3. 如果关键词是 HTML 特殊字符，会被转义处理
4. 中文会按字符拆分高亮，可能会高亮一些不相关的字（这是为了支持不相邻关键词的权衡）

## 💡 为什么中文按字符拆分？

这是为了解决中文搜索的特殊性：

**问题**：用户搜索"机器 学习"（两个词不相邻）
- 文档中有："机器学习是人工智能的分支"
- 如果按词组匹配，无法高亮（因为"机器"和"学习"在文档中是连在一起的）

**解决方案**：按字符拆分
- 提取关键词：['机', '器', '学', '习']
- 高亮所有包含这些字的地方
- 这样无论关键词是否相邻，都能正确高亮

**优点**：
- ✅ 支持不相邻关键词搜索
- ✅ 支持部分匹配
- ✅ 更灵活的搜索体验

**缺点**：
- ⚠️ 可能会高亮一些不相关的字（例如搜索"机器"会高亮"随机"中的"机"）
- ⚠️ 高亮标记较多，视觉上可能略显密集

## 📚 相关文件

- `app/api.py` - API 路由和高亮逻辑
- `app/static/script.js` - 前端交互
- `app/static/style.css` - 样式定义
- `app/search_service.py` - 搜索服务（搜索结果中的高亮）
