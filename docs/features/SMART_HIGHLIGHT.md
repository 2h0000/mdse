# 🎯 智能优先级高亮功能

## 概述

新的智能高亮系统会**优先高亮完整的关键词**，只有在找不到完整匹配时才会退化到单字符高亮。

## 🔍 工作原理

### 三级优先级策略

```
优先级 1（最高）：完整查询
    ↓ 找不到
优先级 2（中等）：词组片段
    ↓ 找不到
优先级 3（最低）：单个字符
```

### 关键词提取规则

**输入**：`机器 学习`

**提取结果**：
1. **完整查询**：`机器 学习`（作为整体）
2. **词组片段**：`机器`、`学习`（按空格分割）
3. **单个字符**：`机`、`器`、`学`、`习`（备用）

## 📊 效果对比

### 场景 1：文档包含完整关键词 ✅

**搜索**：`机器学习`

**文档内容**：
```
机器学习是人工智能的一个分支。深度学习也是机器学习的子领域。
```

**高亮结果**：
```
【机器学习】是人工智能的一个分支。深度学习也是【机器学习】的子领域。
```

**说明**：
- ✅ 完整的"机器学习"被高亮
- ✅ "深度学习"中的"学习"**不会**被高亮（因为找到了完整匹配）
- ✅ 视觉效果清晰，不会过度高亮

---

### 场景 2：文档不包含完整关键词 ⚠️

**搜索**：`机器学习`

**文档内容**：
```
这篇文章讨论了机器人技术和学习算法。
```

**高亮结果**：
```
这篇文章讨论了【机】【器】人技术和【学】【习】算法。
```

**说明**：
- ⚠️ 找不到完整的"机器学习"
- ⚠️ 退化到单字符高亮
- ✅ 仍然能帮助用户找到相关内容

---

### 场景 3：搜索多个词（都存在）✅

**搜索**：`机器 学习`（注意空格）

**文档内容**：
```
机器学习是人工智能的分支。
```

**高亮结果**：
```
【机器】【学习】是人工智能的分支。
```

**说明**：
- ✅ "机器"和"学习"分别高亮
- ✅ 不会高亮单个字符
- ✅ 清晰显示两个词组

---

### 场景 4：搜索多个词（部分存在）✅

**搜索**：`深度 学习`

**文档内容**：
```
机器学习是人工智能的分支。
```

**高亮结果**：
```
机器【学习】是人工智能的分支。
```

**说明**：
- ✅ 只高亮找到的"学习"
- ✅ "深度"不存在，不会误高亮其他字
- ✅ 精确匹配

---

### 场景 5：英文搜索 ✅

**搜索**：`machine learning`

**文档内容**：
```
Machine Learning is a subset of AI. The machine is learning.
```

**高亮结果**：
```
【Machine Learning】 is a subset of AI. The 【machine】 is 【learning】.
```

**说明**：
- ✅ 完整的"Machine Learning"被高亮
- ✅ 单独的"machine"和"learning"也被高亮
- ✅ 不区分大小写

---

### 场景 6：中英文混合 ✅

**搜索**：`Python 机器学习`

**文档内容**：
```
Python 是机器学习最常用的语言。学习 Python 很重要。
```

**高亮结果**：
```
【Python】 是【机器学习】最常用的语言。学习 【Python】 很重要。
```

**说明**：
- ✅ "Python"被高亮（2次）
- ✅ "机器学习"被高亮
- ✅ 第二句的"学习"**不会**被高亮（因为找到了完整匹配）

---

## 🎨 视觉效果对比

### 旧版本（总是拆分）

**搜索**：`机器学习`

**结果**：
```
【机】【器】【学】【习】是人工智能的分支。深度【学】【习】也是【机】【器】【学】【习】的子领域。
```

❌ 问题：
- 过度高亮，视觉混乱
- 难以识别完整词组
- "深度学习"中的"学习"也被高亮

### 新版本（智能优先级）

**搜索**：`机器学习`

**结果**：
```
【机器学习】是人工智能的分支。深度学习也是【机器学习】的子领域。
```

✅ 优点：
- 清晰显示完整词组
- 视觉效果简洁
- 只高亮真正相关的内容

---

## 🔧 技术实现

### 算法流程

```python
def smart_highlight(content, query):
    # 1. 提取关键词（按优先级）
    keywords = extract_keywords_with_priority(query)
    # 返回：[('full', '机器学习'), ('phrase', '机器'), ('phrase', '学习'), 
    #        ('char', '机'), ('char', '器'), ...]
    
    # 2. 先尝试高亮完整查询和词组
    for priority, keyword in keywords:
        if priority in ['full', 'phrase']:
            content = highlight_keyword(content, keyword)
    
    # 3. 检查是否有高亮
    has_highlights = check_if_highlighted(content)
    
    # 4. 如果没有找到，才使用单字符高亮
    if not has_highlights:
        for priority, keyword in keywords:
            if priority == 'char':
                content = highlight_keyword(content, keyword)
    
    return content
```

### 关键特性

1. **避免重复高亮**
   - 使用占位符机制
   - 已高亮的内容不会再次高亮

2. **智能判断**
   - 检查是否找到完整匹配
   - 动态决定是否使用单字符高亮

3. **中英文兼容**
   - 中文：直接匹配
   - 英文：使用词边界（`\b`）

---

## 📈 性能优化

### 优化点

1. **减少高亮标记数量**
   - 旧版本：可能产生几十个 `<mark>` 标签
   - 新版本：只高亮真正相关的内容

2. **提升可读性**
   - 用户能快速识别关键词
   - 减少视觉干扰

3. **精确匹配**
   - 减少误报（如"随机"中的"机"）
   - 提高搜索体验

---

## 🎯 使用建议

### 获得最佳效果

1. **搜索完整词组**
   ```
   ✅ 推荐：机器学习
   ⚠️ 可用：机器 学习
   ```

2. **使用具体关键词**
   ```
   ✅ 好：深度学习算法
   ❌ 太宽泛：学习
   ```

3. **多关键词搜索**
   ```
   ✅ 好：Python 机器学习
   ✅ 好：神经网络 卷积
   ```

### 预期行为

| 搜索 | 文档内容 | 高亮结果 | 说明 |
|------|---------|---------|------|
| `机器学习` | `机器学习入门` | `【机器学习】入门` | ✅ 完整匹配 |
| `机器学习` | `机器人和学习` | `【机】【器】人和【学】【习】` | ⚠️ 单字符匹配 |
| `机器 学习` | `机器学习入门` | `【机器】【学习】入门` | ✅ 词组匹配 |
| `深度学习` | `机器学习入门` | `机器学习入门` | ❌ 无匹配 |

---

## 🚀 测试方法

### 1. 运行测试脚本

```bash
python test_smart_highlight.py
```

查看各种场景的高亮效果。

### 2. 浏览器测试

1. 重启服务器
2. 访问 http://127.0.0.1:8000
3. 测试以下搜索：
   - `机器学习` - 应该高亮完整词组
   - `机器 学习` - 应该分别高亮
   - `Python机器学习` - 应该高亮两个词
   - `算法` - 如果文档有"算法"就高亮，否则高亮"算"和"法"

### 3. 对比测试

**测试文档**：包含"机器学习是人工智能的分支"

| 搜索 | 旧版本 | 新版本 |
|------|--------|--------|
| `机器学习` | 【机】【器】【学】【习】 | 【机器学习】 |
| `机器 学习` | 【机】【器】【学】【习】 | 【机器】【学习】 |

---

## 💡 常见问题

### Q1: 为什么有时还是会看到单字符高亮？

**A**: 当文档中**不包含完整关键词**时，系统会退化到单字符高亮，帮助你找到相关内容。

**示例**：
- 搜索：`机器学习`
- 文档：`机器人技术和学习算法`
- 结果：高亮"机"、"器"、"学"、"习"（因为没有完整的"机器学习"）

### Q2: 如何避免单字符高亮？

**A**: 使用更具体的搜索词，或者搜索文档中确实存在的词组。

### Q3: 搜索多个词时如何工作？

**A**: 系统会尝试匹配每个词组，只要找到任何一个词组，就不会使用单字符高亮。

**示例**：
- 搜索：`深度 学习`
- 文档：`机器学习入门`
- 结果：只高亮"学习"（找到了一个词组）

---

## 📚 相关文件

- `app/api.py` - 智能高亮实现
- `test_smart_highlight.py` - 测试脚本
- `HIGHLIGHT_EXAMPLES.md` - 更多示例
